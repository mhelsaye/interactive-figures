<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Damped SDOF Response (Component Visualization)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #fff;
      color: #000;
    }

    /* Flex container for rows */
    #constants, #controls, #toggles {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: nowrap;
      gap: 30px;
      margin: 10px 0;
    }

    .constant, .control {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Input styling */
    input[type="number"], input[type="range"] {
      width: 150px;
    }

    input[type="number"] {
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px;
    }
    
    input[type="text"] {
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px;
      width: 100px;
      background: #f9f9f9;
      color: #333;
      font-weight: bold;
    }

    /* Checkbox styling */
    .toggle-label {
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      user-select: none;
    }

    canvas {
      max-width: 800px;
      width: 100%;
      height: 400px;
      margin: 10px auto;
      display: block;
      background: #fff;
    }
  </style>
</head>
<body>
  <div id="constants">
    <div class="constant">
      <label for="tMax" style="font-size: 14px;">Duration (Periods <i>T</i>)</label>
      <input type="number" id="tMax" value="7" step="1" min="0.5" max="15">
    </div>
    <div class="constant">
      <label style="font-size: 14px;">Magnification <i>|H|</i></label>
      <input type="text" id="magFactor" value="-" disabled>
    </div>
    <div class="constant">
        <label style="font-size: 14px;">Phase Lag <i>φ</i> (deg)</label>
        <input type="text" id="phaseLag" value="-" disabled>
      </div>
  </div>

  <div id="controls">
    <div class="control">
      <label for="rRatio" style="font-size: 14px;">
        Frequency Ratio<br>
        <i> r = ω/ωₙ </i> = <span id="r_val">0.90</span>
      </label>
      <input type="range" id="rRatio" min="0.2" max="2.0" step="0.01" value="0.67">
    </div>

    <div class="control">
      <label for="zeta" style="font-size: 14px;">
        Damping Ratio<br>
        <i> ζ </i> = <span id="zeta_val">0.05</span>
      </label>
      <input type="range" id="zeta" min="0.0" max="0.8" step="0.01" value="0.05">
    </div>
  </div>

  <div id="toggles">
    <label class="toggle-label">
      <input type="checkbox" id="showTotal" checked>
      <span style="color: red; font-weight: bold;">— Total</span>
    </label>
    <label class="toggle-label">
      <input type="checkbox" id="showSteady" checked>
      <span style="color: black; font-weight: bold;">- - Steady State</span>
    </label>
    <label class="toggle-label">
      <input type="checkbox" id="showTransient">
      <span style="color: blue; font-weight: bold;">··· Transient</span>
    </label>
  </div>

  <canvas id="plot"></canvas>

  <script>
    // --- Style Settings ---
    Chart.defaults.devicePixelRatio = 2;
    Chart.defaults.font.size = 14;

    const canvas = document.getElementById("plot");
    const ctx = canvas.getContext("2d");

    // --- Physics Engine ---
    
    // We normalize the forcing frequency omega = 2*PI. 
    // This makes the forcing period T = 1 unit of time.
    const OMEGA_FORCE = 2 * Math.PI;

    function computeDampedResponse(r, zeta, maxPeriods) {
        const ptsTotal = [];
        const ptsSteady = [];
        const ptsTransient = []; // NEW: Store transient separately
        const dt = 0.01; 

        // 1. System Properties
        const omega_n = OMEGA_FORCE / r;
        
        // Damped natural frequency
        const safeZeta = Math.min(zeta, 0.99); 
        const omega_d = omega_n * Math.sqrt(1 - safeZeta * safeZeta);

        // 2. Steady State Parameters
        const denomSquared = Math.pow(1 - r*r, 2) + Math.pow(2 * safeZeta * r, 2);
        let M = (denomSquared < 1e-6) ? 50 : 1 / Math.sqrt(denomSquared);
        const phi = Math.atan2(2 * safeZeta * r, 1 - r * r);

        // 3. Transient Parameters (Initial Conditions: u=0, v=0)
        const A = M * Math.sin(phi);
        const numeratorB = (safeZeta * omega_n * A) - (OMEGA_FORCE * M * Math.cos(phi));
        const B = numeratorB / omega_d;

        // 4. Generate Time History
        for (let i = 0; i <= maxPeriods / dt; i++) {
            const t = i * dt; 

            // Steady State: u_ss = M * sin(w*t - phi)
            const u_ss = M * Math.sin(OMEGA_FORCE * t - phi);

            // Transient: u_tr = e^(-z*wn*t) * (A*cos(wd*t) + B*sin(wd*t))
            const decay = Math.exp(-safeZeta * omega_n * t);
            const u_tr = decay * (A * Math.cos(omega_d * t) + B * Math.sin(omega_d * t));

            // Total = Transient + Steady State
            const u_tot = u_tr + u_ss;

            ptsTotal.push({ x: t, y: u_tot });
            ptsSteady.push({ x: t, y: u_ss });
            ptsTransient.push({ x: t, y: u_tr });
        }

        return { 
            total: ptsTotal, 
            steady: ptsSteady, 
            transient: ptsTransient,
            mag: M, 
            phase: phi * (180/Math.PI) 
        };
    }

    // --- Chart Plugin: Axes Lines ---
    const axesLines = {
      id: 'axesLines',
      afterDraw(chart) {
        const { ctx, chartArea: { left, right, top, bottom }, scales: { x, y } } = chart;
        ctx.save();
        ctx.strokeStyle = '#666';
        ctx.lineWidth = 1;

        // x-axis (y=0)
        const yZero = y.getPixelForValue(0);
        if (yZero >= top && yZero <= bottom) {
          ctx.beginPath();
          ctx.moveTo(left, yZero);
          ctx.lineTo(right, yZero);
          ctx.stroke();
        }

        // y-axis (t=0)
        const xZero = x.getPixelForValue(0);
        if (xZero >= left && xZero <= right) {
          ctx.beginPath();
          ctx.moveTo(xZero, top);
          ctx.lineTo(xZero, bottom);
          ctx.stroke();
        }
        ctx.restore();
      }
    };

    // --- Chart Initialization ---
    const chart = new Chart(ctx, {
      type: "line",
      data: {
        datasets: [
          {
            label: "Total Response",
            data: [], 
            borderColor: "red",
            borderWidth: 2,
            pointRadius: 0,
            fill: false,
            order: 1
          },
          {
            label: "Steady-state",
            data: [],
            borderColor: "black",
            borderWidth: 1.5,
            borderDash: [6, 6],
            pointRadius: 0,
            fill: false,
            order: 2
          },
          {
            label: "Transient",
            data: [],
            borderColor: "blue",
            borderWidth: 1.5,
            borderDash: [2, 4],
            pointRadius: 0,
            fill: false,
            hidden: true, // Hidden by default
            order: 3
          }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        interaction: { mode: 'nearest', axis: 'x', intersect: false },
        scales: {
          x: {
            type: "linear",
            min: 0, 
            ticks: {
              color: "black",
              stepSize: 1,
              callback: v => Number.isInteger(v) ? v : ""
            },
            grid: { color: "#f0f0f0", drawBorder: false },
            title: { display: true, text: "Normalized Time (t/T)", color: "black", font: { size: 16 } }
          },
          y: {
            min: -6, max: 6, 
            ticks: { color: "black" },
            grid: { color: "#f0f0f0", drawBorder: false },
            title: { display: true, text: "Displacement u(t)/ust", color: "black", font: { size: 16 } }
          }
        },
        plugins: {
          legend: { display: false }, // We use custom checkboxes
          tooltip: { enabled: true }
        },
        layout: { padding: 10 }
      },
      plugins: [axesLines]
    });

    // --- Interaction Logic ---
    function updatePlot() {
      // Get values
      const r = parseFloat(document.getElementById("rRatio").value);
      const zeta = parseFloat(document.getElementById("zeta").value);
      const tMax = parseFloat(document.getElementById("tMax").value);

      // Update Label Text
      document.getElementById("r_val").textContent = r.toFixed(2);
      document.getElementById("zeta_val").textContent = zeta.toFixed(2);
      
      // Update Scale Max
      chart.options.scales.x.max = tMax;

      // Compute Physics
      const data = computeDampedResponse(r, zeta, tMax);

      // Update Info Boxes
      let mText = data.mag.toFixed(2);
      if(data.mag > 50) mText = "> 50";
      document.getElementById("magFactor").value = mText;
      document.getElementById("phaseLag").value = data.phase.toFixed(1);

      // Push Data to Chart
      chart.data.datasets[0].data = data.total;
      chart.data.datasets[1].data = data.steady;
      chart.data.datasets[2].data = data.transient;

      // Update Visibility based on checkboxes
      chart.getDatasetMeta(0).hidden = !document.getElementById("showTotal").checked;
      chart.getDatasetMeta(1).hidden = !document.getElementById("showSteady").checked;
      chart.getDatasetMeta(2).hidden = !document.getElementById("showTransient").checked;

      chart.update();
    }

    // Attach listeners
    document.querySelectorAll("input").forEach(el =>
      el.addEventListener("input", updatePlot)
    );

    // Initial load
    updatePlot();
  </script>
</body>
</html>
